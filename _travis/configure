#!/bin/bash

# Print commands as executed and fail on error
set -ex

# activate ccache if exists
if [ -d /usr/lib/ccache ] ; then
	export PATH="/usr/lib/ccache:$PATH"
fi

# Travis' clang is not in standard directory,
# so the /usr/lib/ccache/clang symlink does
# not exist.
#
# Set it up manually inside homedir:

if [ "$CC" = "clang" -a "$TRAVIS_OS_NAME" = "linux" ]; then
	mkdir "$HOME/bin"
	ln -s /usr/bin/ccache "$HOME/bin/clang"
	ln -s /usr/bin/ccache "$HOME/bin/clang++"
	export PATH="$HOME/bin:$PATH"

	CXXFLAGS+="Wno-error=unused-argument"
fi

# Test inside-git build system
mkdir build
cd build

CMAKE_PARAMETERS="-DCMAKE_VERBOSE_MAKEFILE=ON"

# on OSX: Download Test PDF,
# rather than install pdflatex
if [ "$TRAVIS_OS_NAME" = "osx" ] ; then
	CMAKE_PARAMETERS+=" -DDownloadTestPDF=ON"
fi

# on Linux, with GCC:
# Activate code coverage analysis
if [ "$TRAVIS_OS_NAME" = "linux" -a "$CXX" = "g++" ] ; then
	# Linux / GCC: Activate coverage
	CMAKE_PARAMETERS+=" -DCodeCoverage=ON"
fi

# Allow switching Qt version via environment variable
if [ "$QT_VERSION" -eq 4 ] ; then
	CMAKE_PARAMETERS+=" -DUseQtFive=OFF"
elif [ "$QT_VERSION" -eq 5 ] ; then
	CMAKE_PARAMETERS+=" -DUseQtFive=ON"
else
	echo "Unknown qt version $QT_VERSION" >&2
	false
fi

cmake $CMAKE_PARAMETERS ..
